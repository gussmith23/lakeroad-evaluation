#!/usr/bin/env bash

set -e
set -u

SCRIPT_DIR=$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )
EVAL_OUTPUT_DIR="$(realpath "$SCRIPT_DIR/../yosys-synth-opt-place-route-lakeroad-ecp5-instrs/")"
export EVAL_OUTPUT_DIR
mkdir -p "$EVAL_OUTPUT_DIR"

BASE_DIR="$(realpath "$SCRIPT_DIR/../")"

instr_files=$(find "$BASE_DIR"/lattice_ecp5_impls -type f)
num_files=$(echo "$instr_files" | wc -l | xargs)
i=0
for instr_file in $instr_files ; do
  basename=$(basename "$instr_file")
  echo "$((i+1)) of $num_files: $basename"
  modname="${basename%.*}"
  base="$EVAL_OUTPUT_DIR/$basename"
  echo "  -> base: $base"
  echo "  -> modname: $modname"
  VLOG_FILE_NAME="$instr_file" \
    OUTPUT_FILE_BASE="$base" \
    MOD_NAME="$modname" \
    yosys \
        -tcl "$SCRIPT_DIR/synthesize-ecp5-lakeroad-impls.tcl" \
  > "$base-synth.log"

  # Get num luts/ccu2c generated by running yosys on lakeroad instructions
  NUM_LUTs=$(sed -nr "s/.*[[:space:]]*LUT4[[:space:]]*([0-9]+)[[:space:]]*/\1/p" "$base-synth.log")
  NUM_CCU2Cs=$(sed -nr "s/.*[[:space:]]*CCU2C[[:space:]]*([0-9]+)[[:space:]]*/\1/p" "$base-synth.log")
  printf "LUTs:%s\n""CCU2Cs:%s\n" "$NUM_LUTs" "$NUM_CCU2Cs" > "$base-synth-util.txt"
  ((i=i+1))

  # Now, run pnr
  json_file="$base-synth.json"
  nextpnr-ecp5 --json "$json_file" 2> "$base-nextpnr.log"

  NUM_LUTs=$(sed -nr "s/.*logic LUTs:[[:space:]]*([0-9]+)\/.*/\1/p" "$base"-nextpnr.log)
  NUM_CARRY_LUTs=$(sed -nr "s/.*carry LUTs:[[:space:]]*([0-9]+)\/.*/\1/p" "$base"-nextpnr.log)
  printf "LOTIC_LUTs:%s\n""CARRY_LUTs:%s\n" "$NUM_LUTs" "$NUM_CARRY_LUTs" > "$base-nextpnr-util.txt"
done